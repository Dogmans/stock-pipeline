# Cache Fix for Universe Functions - 2024-11-13

## Problem
The stock screening pipeline was failing with "Selected 0 symbols for analysis" due to a critical caching bug in the universe selection functions.

## Root Cause
Flask-Caching's `@cache.memoize` decorator includes **ALL** function parameters in the cache key. This means:
- `get_sp500_symbols()` creates cache key: `function_name::()`
- `get_sp500_symbols(force_refresh=False)` creates cache key: `function_name::(False,)`

These are treated as **separate cache entries**, causing inconsistent behavior where some calls returned cached data and others returned empty results.

## Solution
Split each universe function into two parts:
1. **Internal cached function**: `_get_*_symbols_cached()` with `@cache.memoize` decorator (no parameters)
2. **Public interface function**: `get_*_symbols(force_refresh=False)` that handles force_refresh logic and calls the cached function

## Functions Fixed
- `get_sp500_symbols()` → `_get_sp500_symbols_cached()`
- `get_russell2000_symbols()` → `_get_russell2000_symbols_cached()` 
- `get_nasdaq_symbols()` → `_get_nasdaq_symbols_cached()`
- `get_dowjones_symbols()` → `_get_dowjones_symbols_cached()`
- `get_stock_universe()` → `_get_stock_universe_cached()`

## Pattern Applied
```python
@cache.memoize(expire=CACHE_EXPIRE)
def _get_symbols_cached():
    """Cached implementation without parameters."""
    # Original function logic here
    pass

def get_symbols(force_refresh=False):
    """Public interface function."""
    if force_refresh:
        cache.delete_memoized(_get_symbols_cached)
    
    return _get_symbols_cached()
```

## Results
- ✅ S&P 500: 503 symbols (was 0)
- ✅ NASDAQ: 101 symbols
- ✅ Dow Jones: 30 symbols
- ✅ Stock screening pipeline working correctly
- ✅ All universe functions have consistent caching behavior

## Key Lesson
When using Flask-Caching's `@memoize`, be extremely careful with function parameters as they become part of the cache key. For optional parameters like `force_refresh`, use the split-function pattern to avoid cache key mismatches.